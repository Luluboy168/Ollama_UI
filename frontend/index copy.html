<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Ollama 聊天室</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>聊天室列表</h2>
      <ul id="session-list"></ul>
      <button id="new-session-btn" onclick="createSession()">建立聊天室</button>
    </div>

    <!-- Chat Area -->
    <div class="chat-area">
      <div id="chat-box"></div>

      <div class="input-area">
        <input type="text" id="chat-input" placeholder="輸入訊息..." />
        <button id="send-btn" onclick="sendMessage()">送出</button>
      </div>
    </div>
  </div>

  <script>
    let currentSessionId = null;
    const apiBase = 'http://127.0.0.1:8000';

    async function createSession() {
      const title = prompt("請輸入聊天室標題:");
      const res = await fetch(`${apiBase}/sessions/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title }),
      });
      await listSessions();
    }

    async function listSessions() {
      const res = await fetch(`${apiBase}/sessions/`);
      const data = await res.json();
      const div = document.getElementById("session-list");
      div.innerHTML = '';
      data.forEach(s => {
        const btn = `<li onclick="loadSession(${s.id})">#${s.id} - ${s.title}</li>`;
        div.innerHTML += btn;
      });
    }

    async function loadSession(id) {
      currentSessionId = id;
      const res = await fetch(`${apiBase}/msgs/${id}`);
      const data = await res.json();
      const box = document.getElementById("chat-box");
      box.innerHTML = '';
      data.forEach(msg => {
        const role = msg.role === 'user' ? '👤' : '🤖';
        const cls = msg.role;
        box.innerHTML += `<div class="message ${cls}">${role}: ${msg.content}</div>`;
      });
      box.scrollTop = box.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById("chat-input");
      const text = input.value.trim();
      if (!currentSessionId || !text) return;
      input.value = "";
      const res = await fetch(`${apiBase}/msgs/${currentSessionId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_msg: text }),
      });
      await loadSession(currentSessionId);
    }

    listSessions();  // 頁面載入時讀取聊天室
  </script>
</body>
</html>
